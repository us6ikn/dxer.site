<!DOCTYPE html>
<html>
  <head>
    <title>Moon Sublunar Point</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }

      #map {
        height: 100dvh;
        width: 100%;
      }

      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        max-width: 90%;
        box-sizing: border-box;
      }

      label {
        font-weight: bold;
        font-size: 14px;
      }

      #hour-value {
        margin-left: 10px;
        font-weight: normal;
      }

      #hour {
        width: 100%;
        margin-top: 5px;
      }

      input[type="date"] {
        width: 100%;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="controls">
      <label for="date">Select Date (UTC):</label><br />
      <input type="date" id="date" /><br />

      <label for="hour">Select Hour (UTC):</label><br />
      <input type="range" id="hour" min="0" max="23" value="0" step="1" />
      <span id="hour-value">00:00</span>
      
      <div id="moon-phase" style="margin-top: 10px;">
        <canvas id="moonCanvas" width="40" height="40"></canvas>
        <span id="phase-label" style="font-size: 12px;"></span>
      </div>
    </div>

    <script>
      let map;
      let moonMarker;
      let footprintCircle;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: { lat: 0, lng: 0 },
          mapTypeId: 'terrain',
          gestureHandling: 'greedy',
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false
        });

        fetch('moon_data_cleaned.txt')
          .then(response => response.json())
          .then(data => {
            window.moonData = data;
            setDefaultTimeAndUpdateMap();
            restrictDatePicker();
          })
          .catch(error => console.error('Error loading moon data:', error));
      }

        
        function drawMoonPhase(phaseFraction) {
          const canvas = document.getElementById('moonCanvas');
          const ctx = canvas.getContext('2d');
          const r = canvas.width / 2;
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Draw full moon background
          ctx.fillStyle = '#ddd';
          ctx.beginPath();
          ctx.arc(r, r, r, 0, 2 * Math.PI);
          ctx.fill();

          // Draw shadow depending on phase (0 = new moon, 1 = full moon)
          ctx.fillStyle = '#222';
          ctx.beginPath();

          if (phaseFraction < 0.5) {
            // Waxing or waning crescent/quarter
            const offset = (0.5 - phaseFraction) * 2 * r;
            ctx.ellipse(r + offset, r, r, r, 0, 0, 2 * Math.PI);
          } else {
            // Gibbous or full
            const offset = (phaseFraction - 0.5) * 2 * r;
            ctx.ellipse(r - offset, r, r, r, 0, 0, 2 * Math.PI);
          }

          ctx.fill();
        }

        
      function setDefaultTimeAndUpdateMap() {
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        const currentHour = now.getUTCHours().toString().padStart(2, '0');

        document.getElementById('date').value = currentDate;
        document.getElementById('hour').value = parseInt(currentHour);
        document.getElementById('hour-value').textContent = `${currentHour}:00`;

        updateMap();
      }

      function restrictDatePicker() {
        const now = new Date();
        const minDate = new Date(now);
        minDate.setDate(now.getDate() - 5);
        const maxDate = new Date(now);
        maxDate.setDate(now.getDate() + 5);

        const minDateString = minDate.toISOString().split('T')[0];
        const maxDateString = maxDate.toISOString().split('T')[0];

        const dateInput = document.getElementById('date');
        dateInput.setAttribute('min', minDateString);
        dateInput.setAttribute('max', maxDateString);
      }

      document.getElementById('hour').addEventListener('input', function () {
        const hourStr = this.value.toString().padStart(2, '0');
        document.getElementById('hour-value').textContent = `${hourStr}:00`;
        updateMap();
      });

      document.getElementById('date').addEventListener('change', updateMap);

      function updateMap() {
        const selectedDate = document.getElementById('date').value;
        const selectedHour = document.getElementById('hour').value.toString().padStart(2, '0');

        if (!selectedDate) {
          alert("Please select a date.");
          return;
        }

        const utcTimeString = new Date(`${selectedDate}T${selectedHour}:00:00Z`)
          .toISOString()
          .slice(0, 19)
          .replace('T', ' ');

        const moonData = window.moonData.find(entry => entry.time === utcTimeString);

        if (!moonData) {
          alert("No moon data available for the selected UTC time.");
          return;
        }

        const lat = parseFloat(moonData.sublunar_lat);
        const lon = -parseFloat(moonData.sublunar_lon); // Negate if needed for direction
        const radius = parseFloat(moonData.footprint_radius_km) * 1000 * 1.02;
        
        document.getElementById('phase-label').textContent = moonData.phase_name;
        drawMoonPhase(parseFloat(moonData.phase_fraction));


        map.setCenter({ lat: 0, lng: 0 });

        if (moonMarker) moonMarker.setMap(null);
        if (footprintCircle) footprintCircle.setMap(null);

        moonMarker = new google.maps.Marker({
          position: { lat, lng: lon },
          map: map,
          icon: {
            url: 'https://dxer.site/eme/moon-icon.png',
            scaledSize: new google.maps.Size(48, 48)
          },
          title: 'Moon Sublunar Point'
        });

        footprintCircle = new google.maps.Circle({
          map: map,
          center: { lat, lng: lon },
          radius: radius,
          fillColor: '#0088FF',
          fillOpacity: 0.3,
          strokeColor: '#0000FF',
          strokeOpacity: 0.6,
          strokeWeight: 2
        });
      }
    </script>

    <!-- Google Maps API -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPRWRoTRhE5TddxBITIhBcKjdQpz2CXRs&callback=initMap">
    </script>
  </body>
</html>
