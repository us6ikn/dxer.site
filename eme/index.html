<!DOCTYPE html>
<html>
  <head>
    <title>Moon Sublunar Point</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #map {
        height: 100dvh;
        width: 100%;
      }

        #controls {
          position: absolute;
          top: 10px;
          left: 10px;
          z-index: 10;
          background-color: rgba(255, 255, 255, 0.95);
          padding: 12px;
          border-radius: 8px;
          max-width: 90vw;
          box-sizing: border-box;
          overflow: auto;
          max-height: 90vh; /* allow scrolling if needed */
        }

      label {
        font-weight: bold;
        font-size: 14px;
      }

      #hour-value {
        margin-left: 10px;
        font-weight: normal;
      }

      #hour {
        width: 100%;
        margin-top: 5px;
      }

      input[type="date"] {
        width: 100%;
        margin-bottom: 10px;
      }

        #chartWrapper {
          width: 100%;
          height: 180px; /* Keep the height of both chart and legend together */
          margin-top: 6px;
          background-color: rgba(255, 255, 255, 0.85);
          border-radius: 6px;
          box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.1);
          overflow: hidden; /* Prevent any horizontal overflow */
          position: relative;
          box-sizing: border-box;
        }


        #gradientLegend {
          position: relative; /* Keep it relative */
          margin-bottom: 0px; /* Spacing between the legend and chart */
          left: 0;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          font-size: 12px;
          color: #333;
          padding: 5px 10px;
          background: rgba(255, 255, 255, 0.8);
          border-radius: 6px 6px 0 0; /* Rounded top corners */
          box-sizing: border-box;
        }



        .gradient-bar {
          flex-grow: 1;
          height: 8px;
          margin: 0 6px;
          background: linear-gradient(to right, rgba(255, 0, 0, 0.05), rgba(255, 0, 0, 0.6));
          border-radius: 4px;
        }



        #declinationChart {
          width: 100%;
          height: calc(100% - 40px); /* Adjust for space needed for the legend */
          box-sizing: border-box; /* Ensure chart doesn't exceed wrapper width */
          padding-bottom: 20px; /* Add space for X-axis labels */
        }





        /* Optional: better mobile spacing */
        @media (max-width: 480px) {
          #controls {
            font-size: 13px;
            padding: 10px;
          }

          #declinationChart {
            height: 80px;
          }
        }
        
        #hour {
          width: 100%;
          margin-top: 5px;
          -webkit-appearance: none; /* For Webkit-based browsers like Chrome/Safari */
          appearance: none; /* For Firefox */
          height: 10px; /* Add height for better touch handling */
          background: rgba(0, 0, 0, 0.1); /* Make background visible */
          border-radius: 5px;
          outline: none;
          transition: background 0.3s ease;
          padding: 0;
        }

        #hour::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px; /* Thumb width */
          height: 20px; /* Thumb height */
          background: #007bff;
          border-radius: 50%;
          cursor: pointer;
        }

        #hour::-moz-range-thumb {
          width: 20px;
          height: 20px;
          background: #007bff;
          border-radius: 50%;
          cursor: pointer;
        }

        #hour:active {
          background: rgba(0, 123, 255, 0.5); /* Active state background */
        }

        #hour-container {
          position: relative;
          width: 100%;
          height: 40px;
          margin-top: 10px;
          padding: 5px 0;
        }

        #date-container {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        
        #date-container input[type="date"] {
          flex-grow: 1;
          padding: 5px;
          margin: 0;
          height: 32px; /* Explicit height for consistency */
          box-sizing: border-box;
          vertical-align: middle;
        }

        #date-container button {
          font-size: 16px;
          padding: 5px 10px;
          background-color: #f1f1f1;
          border: 1px solid #ccc;
          border-radius: 5px;
          cursor: pointer;
          height: 32px; /* Match the height of the date input */
          box-sizing: border-box;
        }

        #prevDay, #nextDay {
          font-size: 16px;
          padding: 5px 10px;
          background-color: #f1f1f1;
          border: 1px solid #ccc;
          border-radius: 5px;
          cursor: pointer;
        }

        #prevDay:hover, #nextDay:hover {
          background-color: #e0e0e0;
        }

        input[type="date"] {
          flex-grow: 1; /* Makes the input field take up remaining space */
          padding: 5px;
        }


    </style>

    <!-- Chart.js and Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  </head>

  <body>
    <div id="map"></div>
    <div id="controls">
          <div id="date-container">
            <button id="prevDay" type="button">‚Üê</button>
            <input type="date" id="date" />
            <button id="nextDay" type="button">‚Üí</button>
          </div>


          <input type="range" id="hour" min="0" max="23" value="0" step="1" />
          <span id="hour-value" style="font-size: 12px;">Time (UTC): 00:00</span>

      <!-- Declination graph inside controls -->
      <div id="chartWrapper">
          <span style="font-size: 12px; display: block; text-align: center;">Degradation</span>

        <div id="gradientLegend">
            
          <span>Low</span>
          <div class="gradient-bar"></div>
          <span>High</span>
        </div>
        <canvas id="declinationChart"></canvas>
      </div>


      </div>


    </div>


    <script>
      let map;
      let moonMarker;
      let footprintCircle;
      let declinationChart;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: { lat: 0, lng: 0 },
          mapTypeId: 'terrain',
          gestureHandling: 'greedy',
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false
        });

        fetch('moon_data_cleaned.txt')
          .then(response => response.json())
          .then(data => {
            window.moonData = data;
            initDeclinationChart(data);
            addDegradationOverlays();
            setDefaultTimeAndUpdateMap();
            restrictDatePicker();
          })
          .catch(error => console.error('Error loading moon data:', error));
      }

      function setDefaultTimeAndUpdateMap() {
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        const currentHour = now.getUTCHours().toString().padStart(2, '0');

        document.getElementById('date').value = currentDate;
        document.getElementById('hour').value = parseInt(currentHour);
        document.getElementById('hour-value').textContent = `Time (UTC): ${currentHour}:00`;

        updateMap();
      }

      function restrictDatePicker() {
        const now = new Date();
        const minDate = new Date(now);
        const maxDate = new Date(now);
        minDate.setDate(minDate.getDate() - 15);
        maxDate.setDate(maxDate.getDate() + 15);

        const minDateString = minDate.toISOString().split('T')[0];
        const maxDateString = maxDate.toISOString().split('T')[0];

        const dateInput = document.getElementById('date');
        dateInput.setAttribute('min', minDateString);
        dateInput.setAttribute('max', maxDateString);
      }

      document.getElementById('hour').addEventListener('input', function () {
        const hourStr = this.value.toString().padStart(2, '0');
        document.getElementById('hour-value').textContent = `Time (UTC): ${hourStr}:00`;
        updateMap();
      });

      document.getElementById('date').addEventListener('change', updateMap);

      function updateMap() {
        const selectedDate = document.getElementById('date').value;
        const selectedHour = document.getElementById('hour').value.toString().padStart(2, '0');

        if (!selectedDate) {
          alert("Please select a date.");
          return;
        }

        const utcTimeString = new Date(`${selectedDate}T${selectedHour}:00:00Z`)
          .toISOString()
          .slice(0, 19)
          .replace('T', ' ');

        const moonData = window.moonData.find(entry => entry.time === utcTimeString);

        if (!moonData) {
          alert("No moon data available for the selected UTC time.");
          return;
        }

        const lat = parseFloat(moonData.sublunar_lat);
        const lon = -parseFloat(moonData.sublunar_lon); // Negate if needed for direction
        const radius = parseFloat(moonData.footprint_radius_km) * 1000 * 1.02;

        map.setCenter({ lat: 0, lng: 0 });

        if (moonMarker) moonMarker.setMap(null);
        if (footprintCircle) footprintCircle.setMap(null);

        moonMarker = new google.maps.Marker({
          position: { lat, lng: lon },
          map: map,
          icon: {
            url: 'https://dxer.site/eme/moon-icon.png',
            scaledSize: new google.maps.Size(48, 48)
          },
          title: 'Moon Sublunar Point'
        });

        footprintCircle = new google.maps.Circle({
          map: map,
          center: { lat, lng: lon },
          radius: radius,
          fillColor: '#0088FF',
          fillOpacity: 0.3,
          strokeColor: '#0000FF',
          strokeOpacity: 0.6,
          strokeWeight: 2
        });

        updateDeclinationHighlight(selectedDate);
      }

        function initDeclinationChart(data) {
          const now = new Date();
          const from = new Date(now);
          const to = new Date(now);
          from.setDate(from.getDate() - 15);
          to.setDate(to.getDate() + 15);

          const filtered = data.filter(entry => {
            const time = new Date(entry.time.replace(' ', 'T') + 'Z');
            return time >= from && time <= to;
          });

          const dateMap = new Map();
          filtered.forEach(entry => {
            const dateStr = entry.time.split(' ')[0];
            if (!dateMap.has(dateStr)) dateMap.set(dateStr, []);
            dateMap.get(dateStr).push(entry);
          });

          const labels = Array.from(dateMap.keys());

          const declinations = labels.map(date => {
            const entries = dateMap.get(date);
            const avgDec = entries.reduce((sum, entry) => sum + parseFloat(entry.dec), 0) / entries.length;
            return parseFloat(avgDec.toFixed(2));
          });

          const distances = labels.map(date => {
            const entries = dateMap.get(date);
            const avgDist = entries.reduce((sum, entry) => sum + parseFloat(entry.distance_km), 0) / entries.length;
            return Math.round(avgDist);
          });

          const ctx = document.getElementById('declinationChart').getContext('2d');
          
          const newMoonDates = filtered
            .filter(entry => entry.phase_name === 'New Moon')
            .map(entry => entry.time.split(' ')[0]);

            // Add new moon annotations to the chart options
            const newMoonAnnotations = {};
            newMoonDates.forEach((dateStr, i) => {
              const index = labels.indexOf(dateStr);
              if (index !== -1) {
                newMoonAnnotations[`newMoon${i}`] = {
                  type: 'line',
                  xValue: dateStr, // corresponds to the label
                  yValue: -28, // within the visible range of your y-axis (-30 to 30)
                  borderColor: 'black',
                  borderWidth: 2,
                  label: {
                    content: 'üåë', // Use a Unicode for the New Moon symbol
                    enabled: true,
                    position: 'top',
                    backgroundColor: 'white',
                    font: {
                      size: 14,
                      weight: 'bold',
                    },
                    padding: 6,
                  },
                };
              }
            });


            // Update the chart options to include new moon annotations
            declinationChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Declination (¬∞)',
                    data: declinations,
                    borderColor: 'blue',
                    yAxisID: 'y',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.2,
                  },
                  {
                    label: 'Distance (km)',
                    data: distances,
                    borderColor: 'green',
                    yAxisID: 'y1',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.2,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                  padding: {
                    bottom: 20, // Add padding below the chart for X-axis labels
                  },
                },
                plugins: {
                  legend: { display: false },
                  annotation: {
                    drawTime: 'beforeDatasetsDraw', // <-- This makes boxes draw behind lines
                    annotations: {
                      todayLine: {
                        type: 'line',
                        xMin: '',
                        xMax: '',
                        borderColor: 'red',
                        borderWidth: 2,
                        label: {
                          display: true,
                          enabled: true,
                          position: 'start',
                          content: function (ctx) {
                            const chart = ctx.chart;
                            const annotation = chart.options.plugins.annotation.annotations.todayLine;
                            const index = chart.data.labels.indexOf(annotation.xMin);
                            if (index === -1) return '';
                            const dec = chart.data.datasets[0]?.data[index];
                            const dist = chart.data.datasets[1]?.data[index];
                            if (dec === undefined || dist === undefined) return '';
                            return `Dec: ${dec}¬∞\nDist: ${Math.round(dist / 1000)}k`;
                          },
                          backgroundColor: 'rgba(255,255,255,0.9)',
                          font: {
                            size: 10,
                            weight: 'normal',
                          },
                          color: 'black',
                          padding: 4,
                        },
                      },
                      ...newMoonAnnotations, // Spread new moon annotations here
                    },
                  },
                },
                scales: {
                  x: {
                    type: 'category',
                    ticks: {
                      callback: function (value, index, ticks) {
                        const label = this.getLabelForValue(value);
                        const date = new Date(label);
                        return date.getUTCDate(); // just the day number
                      },
                    },
                  },
                  y: {
                    title: {
                      display: true,
                      text: 'Declination (¬∞)',
                      color: 'blue', // ‚Üê matches blue declination line
                    },
                    min: -30,
                    max: 30,
                    position: 'left',
                    ticks: {
                      color: 'blue', // Optional: make tick numbers blue too
                      stepSize: 10, // Set step size to reduce the number of ticks
                    },
                  },
                  y1: {
                    position: 'right',
                    title: {
                      display: true,
                      text: 'Distance (km)',
                      color: 'green', // ‚Üê matches green distance line
                    },
                    min: 356400,
                    max: 406700,
                    grid: { drawOnChartArea: false },
                    ticks: {
                      callback: function (value) {
                        return (value / 1000).toFixed(0) + 'k';
                      },
                      color: 'green', // Optional: make tick numbers green too
                      stepSize: 20000, // Set step size to reduce the number of ticks
                    },
                  },
                },
              },
              plugins: [Chart.registry.getPlugin('annotation')],
            });

        }


        function updateDeclinationHighlight(dateStr) {
          if (!declinationChart) return;

          const labels = declinationChart.data.labels;
          const index = labels.indexOf(dateStr);
          if (index === -1) return;

          const annotation = declinationChart.options.plugins.annotation.annotations.todayLine;
          annotation.xMin = dateStr;
          annotation.xMax = dateStr;

          declinationChart.update();
        }

        function addDegradationOverlays() {
          fetch('degrad_data.txt')
            .then(response => response.text())
            .then(text => {
              const lines = text.trim().split('\n');
              const degradData = lines.map(line => {
                const [date, value] = line.trim().split(/\s+/);
                return { date, value: parseFloat(value) };
              });

              const chartLabels = declinationChart.data.labels;
              const annotations = [];

              degradData.forEach(d => {
                const index = chartLabels.indexOf(d.date);
                if (index !== -1) {
                  const alpha = (d.value / 10).toFixed(2); // scale to 0‚Äì1 range as needed
                  annotations.push({
                    type: 'box',
                    xMin: index - 0.5,
                    xMax: index + 0.5,
                    backgroundColor: `rgba(255, 0, 0, ${alpha})`,
                    borderColor: 'transparent',
                    borderWidth: 0,
                    yScaleID: 'y',
                    yMin: -90,
                    yMax: 90
                  });
                }
              });

              const chartAnn = declinationChart.options.plugins.annotation.annotations;
              annotations.forEach((ann, i) => {
                chartAnn[`degradBox${i}`] = ann;
              });

              declinationChart.update('none');
            })
            .catch(err => console.error('Error loading degradation data:', err));
        }


        document.getElementById('prevDay').addEventListener('click', function() {
          changeDateByDays(-1); // Decrease date by 1
        });

        document.getElementById('nextDay').addEventListener('click', function() {
          changeDateByDays(1); // Increase date by 1
        });

        function changeDateByDays(delta) {
          const dateInput = document.getElementById('date');
          const selectedDate = new Date(dateInput.value);
          selectedDate.setDate(selectedDate.getDate() + delta);

          // Format the new date to YYYY-MM-DD for the input field
          const formattedDate = selectedDate.toISOString().split('T')[0];
          dateInput.value = formattedDate;

          // Update the map and chart for the new date
          updateMap();
        }


    </script>

    <!-- Google Maps API -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPRWRoTRhE5TddxBITIhBcKjdQpz2CXRs&callback=initMap">
    </script>
  </body>
</html>
