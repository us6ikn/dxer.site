<!DOCTYPE html>
<html>
  <head>
    <title>Moon Sublunar Point</title>
    <meta charset="utf-8" />
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.7);
        padding: 20px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
      }
      label {
        font-weight: bold;
      }
      #hour-value {
        margin-left: 10px;
        font-weight: normal;
      }
      #hour {
        width: 200px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="controls">
      <label for="date">Select Date (UTC):</label><br />
      <input type="date" id="date" value="" /><br />
      
      <label for="hour">Select Hour (UTC):</label><br />
      <input type="range" id="hour" min="0" max="23" value="0" step="1" />
      <span id="hour-value">00:00</span><br />
    </div>

    <script>
      // Initialize the Google Map
      function initMap() {
        const map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: { lat: 0, lng: 0 },
          mapTypeId: 'terrain'
        });

        // Load the moon data
        fetch('moon_data_cleaned.txt')
          .then(response => response.json())
          .then(data => {
            window.moonData = data;  // Store moon data globally
            setDefaultTimeAndUpdateMap(); // Set default time (current date and hour) and update map
            restrictDatePicker(); // Restrict date range (today Â±5 days)
          })
          .catch(error => console.error('Error loading moon data:', error));
      }

      // Set default date and hour to current time when page loads
      function setDefaultTimeAndUpdateMap() {
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0]; // Get the current date (YYYY-MM-DD)
        const currentHour = now.getUTCHours(); // Get the current hour (0-23)

        // Convert currentHour to string and apply padStart
        const currentHourStr = currentHour.toString().padStart(2, '0');

        // Set default values in the inputs
        document.getElementById('date').value = currentDate;
        document.getElementById('hour').value = currentHour;
        document.getElementById('hour-value').textContent = `${currentHourStr}:00`;

        updateMap(); // Update the map with the default values
      }

      // Restrict the date picker to only allow dates from -5 to +5 days around today
      function restrictDatePicker() {
        const now = new Date();
        const minDate = new Date(now);
        minDate.setDate(now.getDate() - 5); // 5 days before today
        const maxDate = new Date(now);
        maxDate.setDate(now.getDate() + 5); // 5 days after today

        // Format dates as YYYY-MM-DD for the date picker
        const minDateString = minDate.toISOString().split('T')[0];
        const maxDateString = maxDate.toISOString().split('T')[0];

        // Set the min and max attributes for the date input
        const dateInput = document.getElementById('date');
        dateInput.setAttribute('min', minDateString);
        dateInput.setAttribute('max', maxDateString);
      }

      // Update hour label when slider is changed
      document.getElementById('hour').addEventListener('input', function() {
        const hour = this.value;
        document.getElementById('hour-value').textContent = `${hour.padStart(2, '0')}:00`;
        updateMap(); // Update map immediately when hour changes
      });

      // Update map when date or hour changes
      document.getElementById('date').addEventListener('change', function() {
        updateMap(); // Update map immediately when date changes
      });

      // Update map based on user-selected date and hour
      function updateMap() {
        const selectedDate = document.getElementById('date').value;
        const selectedHour = document.getElementById('hour').value;

        if (!selectedDate) {
          alert("Please select a date.");
          return;
        }

        // Combine selected date and hour into a full UTC time string
        const combinedDateTime = new Date(`${selectedDate}T${selectedHour.padStart(2, '0')}:00:00Z`);

        const selectedHourUTC = combinedDateTime.toISOString().slice(0, 19).replace('T', ' '); // Format as UTC

        const moonData = window.moonData.find(entry => entry.time === selectedHourUTC);

        if (!moonData) {
          alert("No moon data available for the selected UTC time.");
          return;
        }

        const lat = parseFloat(moonData.sublunar_lat);
        const lon = parseFloat(moonData.sublunar_lon);
        const footprintRadiusKm = parseFloat(moonData.footprint_radius_km);

        const map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: { lat: 0, lng: 0 },
          mapTypeId: 'terrain'
        });

        // Add moon icon marker
        new google.maps.Marker({
          position: { lat, lng: -lon },
          map: map,
          icon: {
            url: 'https://dxer.site/eme/moon-icon.png',
            scaledSize: new google.maps.Size(48, 48)
          },
          title: 'Moon Sublunar Point'
        });

        // Add footprint radius circle centered at the sublunar point
        const footprintCircle = new google.maps.Circle({
          map: map,
          center: { lat: lat, lng: -lon },
          radius: footprintRadiusKm * 1000 * 1.01, // Convert km to meters
          fillColor: '#0088FF',
          fillOpacity: 0.3,
          strokeColor: '#0000FF',
          strokeOpacity: 0.6,
          strokeWeight: 2,
        });
      }
    </script>

    <!-- Load Google Maps API -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPRWRoTRhE5TddxBITIhBcKjdQpz2CXRs&callback=initMap">
    </script>
  </body>
</html>
