<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10GHz EME Stations Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script> <!-- Annotation Plugin -->
    <script>
        // Fetch data from JSON files
        async function fetchData(file) {
            const response = await fetch(file);
            return await response.json();
        }

        // Function to extract antenna size (m) from antenna description
        function getAntennaSize(antennaStr) {
            let regex = /(\d+(\.\d+)?)(m|ft)/;
            let match = antennaStr.match(regex);
            if (match) {
                return parseFloat(match[1]);
            }
            return 0; // Default if no size is found
        }

        // Function to extract power (in W) from power description
        function getPower(powerStr) {
            let regex = /(\d+)(W|w)/;
            let match = powerStr.match(regex);
            if (match) {
                return parseInt(match[1]);
            }
            return 0; // Default if no power is found
        }

        // Helper function to compute the distribution of values (binned into ranges)
        function computeBinnedDistribution(values, binSize) {
            let bins = {};
            values.forEach(value => {
                let bin = Math.floor(value / binSize) * binSize;
                bins[bin] = (bins[bin] || 0) + 1;
            });
            let total = values.length;
            let binnedDistribution = [];
            for (let bin in bins) {
                let percentage = (bins[bin] / total) * 100;
                binnedDistribution.push({ bin: parseFloat(bin), percentage });
            }
            return binnedDistribution.sort((a, b) => a.bin - b.bin);
        }

        // Helper function to compute median
        function median(values) {
            values.sort((a, b) => a - b);
            const half = Math.floor(values.length / 2);
            return values.length % 2 ? values[half] : (values[half - 1] + values[half]) / 2.0;
        }

        // Helper function to compute average
        function average(values) {
            const sum = values.reduce((acc, value) => acc + value, 0);
            return sum / values.length;
        }

        // Setup the charts
        async function setupCharts() {
            // Load the two JSON files
            let data1 = await fetchData('output_2_10GHz.json');
            let data2 = await fetchData('output_2_10GHz_SK.json');
            let allData = [...data1, ...data2];

            // Get antenna sizes and power values
            let antennaSizes = allData.map(item => getAntennaSize(item.Antenna));
            let powerValues = allData.map(item => getPower(item.Power));

            // Compute binned distributions (for example: bin size of 0.5m for antenna size)
            let antennaDistribution = computeBinnedDistribution(antennaSizes, 0.5);  // Binning by 0.5m
            let powerDistribution = computeBinnedDistribution(powerValues, 25);  // Binning by 25W

            // Calculate averages and medians
            let antennaAvg = average(antennaSizes);
            let antennaMedian = median(antennaSizes);
            let powerAvg = average(powerValues);
            let powerMedian = median(powerValues);

            // Prepare chart data (for shaded area, we'll use 'fill' in Chart.js)
            let antennaLabels = antennaDistribution.map(item => `${item.bin}m`);
            let antennaData = antennaDistribution.map(item => item.percentage);

            let powerLabels = powerDistribution.map(item => `${item.bin}W`);
            let powerData = powerDistribution.map(item => item.percentage);

            // Antenna Size Distribution Chart
            new Chart(document.getElementById('antennaChart'), {
                type: 'line',
                data: {
                    labels: antennaLabels,
                    datasets: [{
                        label: 'Antenna Size Distribution (%)',
                        data: antennaData,
                        fill: true, // Creates a shaded area under the line
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 10 } }
                    },
                    plugins: {
                        annotation: {
                            annotations: [
                                {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: antennaAvg,
                                    borderColor: 'green',
                                    borderWidth: 2,
                                    label: {
                                        content: `Avg: ${antennaAvg.toFixed(2)}m`,
                                        enabled: true,
                                        position: "top"
                                    }
                                },
                                {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: antennaMedian,
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    label: {
                                        content: `Median: ${antennaMedian.toFixed(2)}m`,
                                        enabled: true,
                                        position: "top"
                                    }
                                }
                            ]
                        }
                    }
                }
            });

            // Power Distribution Chart
            new Chart(document.getElementById('powerChart'), {
                type: 'line',
                data: {
                    labels: powerLabels,
                    datasets: [{
                        label: 'Power Distribution (%)',
                        data: powerData,
                        fill: true, // Creates a shaded area under the line
                        backgroundColor: 'rgba(53, 162, 235, 0.2)',
                        borderColor: 'rgba(53, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 10 } }
                    },
                    plugins: {
                        annotation: {
                            annotations: [
                                {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: powerAvg,
                                    borderColor: 'green',
                                    borderWidth: 2,
                                    label: {
                                        content: `Avg: ${powerAvg.toFixed(2)}W`,
                                        enabled: true,
                                        position: "top"
                                    }
                                },
                                {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: powerMedian,
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    label: {
                                        content: `Median: ${powerMedian.toFixed(2)}W`,
                                        enabled: true,
                                        position: "top"
                                    }
                                }
                            ]
                        }
                    }
                }
            });
        }

        // Call setupCharts on page load
        window.onload = setupCharts;
    </script>
</head>
<body>
    <h1>10GHz EME Stations Statistics</h1>
    <h2>Antenna Size Distribution</h2>
    <canvas id="antennaChart" width="400" height="200"></canvas>
    <h2>Power Distribution</h2>
    <canvas id="powerChart" width="400" height="200"></canvas>
</body>
</html>
