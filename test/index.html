<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Topocentric Libration Calculator</title>
</head>
<body>
  <h2>Topocentric Libration Calculator</h2>
  <label>Date (YYYY-MM-DD): <input type="date" id="dateInput" value="2010-06-14"></label><br>
  <label>Latitude (deg): <input type="number" id="latInput" value="60.0"></label><br>
  <label>Longitude (deg): <input type="number" id="lonInput" value="0.0"></label><br>
  <button onclick="computeLibration()">Compute</button>

  <pre id="output"></pre>

  <script>
    let data = null;

    async function loadData() {
      const res = await fetch('libration_data.json');
      data = await res.json();
    }

    function computeLibration() {
      const date = document.getElementById('dateInput').value;
      const lat = parseFloat(document.getElementById('latInput').value);
      const lon = parseFloat(document.getElementById('lonInput').value);
      const dt = date + 'T00:00:00Z';
      const entry = data.find(d => d.datetime === dt);
      if (!entry) {
        document.getElementById('output').textContent = 'No data for that date';
        return;
      }

      // Convert observer position to cartesian coordinates (approximate)
      const R = 6378.137; // Earth radius in km
      const phi = lat * Math.PI / 180;
      const lambda = lon * Math.PI / 180;
      const obs = [
        R * Math.cos(phi) * Math.cos(lambda),
        R * Math.cos(phi) * Math.sin(lambda),
        R * Math.sin(phi)
      ];

      // Compute topocentric vector in ICRF
      const moon_icrf = entry.moon_vector_icrf;
      const topocentric_icrf = moon_icrf.map((m, i) => m - obs[i] / 149597870.7); // km to AU

      // Rotate to Moon body-fixed frame
      const Rmat = entry.moon_rotation;
      const rotated = [
        Rmat[0][0]*topocentric_icrf[0] + Rmat[0][1]*topocentric_icrf[1] + Rmat[0][2]*topocentric_icrf[2],
        Rmat[1][0]*topocentric_icrf[0] + Rmat[1][1]*topocentric_icrf[1] + Rmat[1][2]*topocentric_icrf[2],
        Rmat[2][0]*topocentric_icrf[0] + Rmat[2][1]*topocentric_icrf[1] + Rmat[2][2]*topocentric_icrf[2]
      ];

      // Compute spherical coordinates
      const r = Math.sqrt(rotated[0]**2 + rotated[1]**2 + rotated[2]**2);
      const lat_topo = Math.asin(rotated[2] / r) * 180 / Math.PI;
      let lon_topo = Math.atan2(rotated[1], rotated[0]) * 180 / Math.PI;
      lon_topo = ((lon_topo + 180) % 360) - 180;

      // Output
      const result = `
Geocentric: Lat ${entry.geo_lat.toFixed(2)}째, Lon ${entry.geo_lon.toFixed(2)}째
Topocentric: Lat ${lat_topo.toFixed(2)}째, Lon ${lon_topo.toFixed(2)}째
`;
      document.getElementById('output').textContent = result;
    }

    loadData();
  </script>
</body>
</html>
