<!DOCTYPE html>
<html>
<head>
  <title>Topocentric Libration</title>
</head>
<body>
  <h1>Topocentric Libration Calculator</h1>
  <label>Date: <input type="date" id="date" value="2010-06-14"></label><br>
  <label>Hour: <input type="number" id="hour" min="0" max="23" value="0"></label>
  <label>Minute: <input type="number" id="minute" min="0" max="59" value="0"></label><br>
  <label>Latitude: <input type="number" id="lat" step="0.1" value="60"></label>
  <label>Longitude: <input type="number" id="lon" step="0.1" value="0"></label><br>
  <button onclick="computeLibration()">Compute</button>
  <pre id="output"></pre>

  <script>
    async function computeLibration() {
      const date = document.getElementById("date").value;
      const hour = document.getElementById("hour").value.padStart(2, '0');
      const minute = document.getElementById("minute").value.padStart(2, '0');
      const timestamp = `${date}T${hour}:${minute}`;
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);

      const res = await fetch('libration_data.json');
      const data = await res.json();

      if (!data[timestamp]) {
        document.getElementById("output").innerText = "No data for this time.";
        return;
      }

      const entry = data[timestamp];
      const R = entry.rotation;
      const lat_geo = entry.lat_geo;
      const lon_geo = entry.lon_geo;

      // Convert observer's lat/lon to unit vector in ICRF (approximation)
      const phi = lat * Math.PI / 180;
      const lambda = lon * Math.PI / 180;
      const x = Math.cos(phi) * Math.cos(lambda);
      const y = Math.cos(phi) * Math.sin(lambda);
      const z = Math.sin(phi);

      const v = [x, y, z];
      const m = R;
      const r = [
        m[0][0]*v[0] + m[0][1]*v[1] + m[0][2]*v[2],
        m[1][0]*v[0] + m[1][1]*v[1] + m[1][2]*v[2],
        m[2][0]*v[0] + m[2][1]*v[1] + m[2][2]*v[2],
      ];

      const topoLat = Math.asin(r[2]) * 180 / Math.PI;
      const topoLon = Math.atan2(r[1], r[0]) * 180 / Math.PI;

      document.getElementById("output").innerText =
        `Geocentric: Lat ${lat_geo.toFixed(2)}째, Lon ${lon_geo.toFixed(2)}째\n` +
        `Topocentric: Lat ${topoLat.toFixed(2)}째, Lon ${topoLon.toFixed(2)}째`;
    }
  </script>
</body>
</html>
