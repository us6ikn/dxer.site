<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Distance, Declination, Azimuth & Altitude (Stockholm) - June 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }
    canvas {
      max-width: 100%;
      margin-bottom: 2em;
    }
  </style>
</head>
<body>

<h2>Moon Distance, Declination, Azimuth & Altitude (Stockholm) - June 2025</h2>
<canvas id="moonChart" width="1000" height="500"></canvas>
<div id="moonriseMoonset"></div>

<script type="module">
    import { julian, moonposition, nutation, sidereal, coord, rise } from "https://cdn.jsdelivr.net/npm/astronomia/+esm";

  // Observer: Stockholm
  const stockholm = {
    lat: 59.3293,   // degrees
    lon: 18.0686,   // degrees (east positive)
    height: 0       // meters above sea level
  };

  const year = 2025;
  const month = 5; // June (0-indexed)

  const startDate = new Date(Date.UTC(year, month, 1));
  const endDate = new Date(Date.UTC(year, month + 1, 1));

  const dates = [];
  const distances = [];
  const declinations = [];
  const azimuths = [];
  const altitudes = [];

  const radToDeg = r => r * (180 / Math.PI);
  const hourMs = 3600 * 1000;

  // Convert ecliptic lon/lat to equatorial ra/dec using mean obliquity
  function eclToEq(lon, lat, jd) {
    const eps = nutation.meanObliquity(jd); // radians
    const sinEps = Math.sin(eps);
    const cosEps = Math.cos(eps);

    const sinLat = Math.sin(lat);
    const cosLat = Math.cos(lat);
    const sinLon = Math.sin(lon);
    const cosLon = Math.cos(lon);

    const sinDec = sinLat * cosEps + cosLat * sinEps * sinLon;
    const dec = Math.asin(sinDec);

    // Right ascension
    const y = sinLon * cosEps - Math.tan(lat) * sinEps;
    const x = cosLon;
    let ra = Math.atan2(y, x);
    if (ra < 0) ra += 2 * Math.PI;

    return { ra, dec };
  }
    function eqToHz(ha, dec, lat) {
      const sinAlt = Math.sin(dec) * Math.sin(lat) + Math.cos(dec) * Math.cos(lat) * Math.cos(ha);
      const alt = Math.asin(sinAlt);

      const cosAz = (Math.sin(dec) - Math.sin(alt) * Math.sin(lat)) / (Math.cos(alt) * Math.cos(lat));
      let az = Math.acos(cosAz);

      // Determine if azimuth should be greater than 180°
      if (Math.sin(ha) > 0) {
        az = 2 * Math.PI - az;
      }

      return { az, alt };
    }

  // Convert equatorial ra/dec to horizontal azimuth/altitude for observer
  function toHorizontal(ra, dec, jd, obs) {
    // Greenwich Sidereal Time in radians
    const gst = sidereal.apparent(jd); // or sidereal.mean(jd)
    // Local Sidereal Time in radians
    let lst = gst + obs.lon * Math.PI / 180;
    lst = lst % (2 * Math.PI);
    if (lst < 0) lst += 2 * Math.PI;

    // Hour angle (HA)
    let ha = lst - ra;
    if (ha < 0) ha += 2 * Math.PI;

    // Convert to horizontal coordinates
    return eqToHz(ha, dec, obs.lat * Math.PI / 180);
  }

  // Compute moonrise and moonset times for given date and observer
  async function findMoonRiseSet(date, obs) {
    // Function returning moon equatorial coords at jd
    const moonEquatorial = jd => {
      const mp = moonposition.position(jd);
      const eq = eclToEq(mp.lon, mp.lat, jd);
      return { ra: eq.ra, dec: eq.dec };
    };

    // Calculate rise/set in Julian dates (UTC)
    const rs = rise.times(moonEquatorial, obs, date);

    const moonriseUTC = rs.rise ? julian.JDToDate(rs.rise).toISOString() : 'No moonrise';
    const moonsetUTC = rs.set ? julian.JDToDate(rs.set).toISOString() : 'No moonset';

    return { moonriseUTC, moonsetUTC };
  }

  // Populate arrays for the entire month at 1-hour intervals
  for (let t = startDate.getTime(); t < endDate.getTime(); t += hourMs) {
    const date = new Date(t);
    const jd = julian.DateToJD(date);

    const mp = moonposition.position(jd);
    const EARTH_RADIUS_KM = 6378.14;
    const distanceKm = mp.range * EARTH_RADIUS_KM;

    const eq = eclToEq(mp.lon, mp.lat, jd);

    const hor = toHorizontal(eq.ra, eq.dec, jd, stockholm);

    dates.push(date.toISOString().slice(0, 16).replace('T', ' '));
    distances.push(distanceKm);
    declinations.push(radToDeg(eq.dec));
    azimuths.push(radToDeg(hor.az));
    altitudes.push(radToDeg(hor.alt));
  }

  // Create Chart.js chart with 4 datasets
  const ctx = document.getElementById('moonChart').getContext('2d');
  const moonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'Moon Distance (km)',
          data: distances,
          borderColor: 'blue',
          yAxisID: 'y1',
          tension: 0.2,
          pointRadius: 0
        },
        {
          label: 'Moon Declination (°)',
          data: declinations,
          borderColor: 'orange',
          yAxisID: 'y2',
          tension: 0.2,
          pointRadius: 0
        },
        {
          label: 'Azimuth (°) - Stockholm',
          data: azimuths,
          borderColor: 'green',
          yAxisID: 'y3',
          tension: 0.2,
          pointRadius: 0
        },
        {
          label: 'Altitude (°) - Stockholm',
          data: altitudes,
          borderColor: 'red',
          yAxisID: 'y4',
          tension: 0.2,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          ticks: { maxRotation: 45, minRotation: 45, maxTicksLimit: 15 },
          title: { display: true, text: 'Date & Time (UTC)' }
        },
        y1: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: 'Distance (km)' },
          min: 356000, max: 406000
        },
        y2: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: 'Declination (°)' },
          grid: { drawOnChartArea: false },
          min: -30, max: 30
        },
        y3: {
          type: 'linear',
          position: 'left',
          offset: true,
          title: { display: true, text: 'Azimuth (°)' },
          grid: { drawOnChartArea: false },
          min: 0, max: 360
        },
        y4: {
          type: 'linear',
          position: 'right',
          offset: true,
          title: { display: true, text: 'Altitude (°)' },
          grid: { drawOnChartArea: false },
          min: -10, max: 90
        }
      },
      plugins: {
        title: {
          display: true,
          text: `Moon Distance, Declination, Azimuth & Altitude – ${year}-${String(month + 1).padStart(2, '0')}`
        },
        legend: {
          position: 'top'
        }
      }
    }
  });

  // Show moonrise and moonset times for June 1, 2025 in Stockholm
  findMoonRiseSet(startDate, stockholm).then(({moonriseUTC, moonsetUTC}) => {
    const div = document.getElementById('moonriseMoonset');
    div.innerHTML = `<h3>Moonrise and Moonset for Stockholm on 2025-06-01 (UTC)</h3>
      <p>Moonrise: ${moonriseUTC}</p>
      <p>Moonset: ${moonsetUTC}</p>`;
  });
</script>

</body>
</html>
