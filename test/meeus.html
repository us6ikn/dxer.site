<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Az/El & Rise/Set Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
    }
    label, input {
      margin: 0.5em;
    }
  </style>
</head>
<body>

<h2>Moon Position Calculator</h2>

<form id="inputForm">
  <label>Latitude: <input type="number" step="0.01" id="lat" value="40.0"></label>
  <label>Longitude: <input type="number" step="0.01" id="lon" value="-74.0"></label>
  <label>Date: <input type="date" id="date" value=""></label>
  <button type="submit">Calculate</button>
</form>

<h3>Moonrise & Moonset</h3>
<p id="riseSetText">No data yet.</p>

<canvas id="azElChart" width="800" height="400"></canvas>

<script language="JavaScript" src="observer.js">
</script>
<script language="JavaScript" src="datetime.js">
</script>
<script language="JavaScript" src="sun.js">
</script>
<script language="JavaScript" src="moon.js">
</script>
<script language="JavaScript" src="planets.js">
</script>
<script language="JavaScript" src="stars.js">
</script>
<script language="JavaScript" src="separation.js">
</script>
<script language="JavaScript" src="util.js">
</script>
<script language="JavaScript" src="math.js">
</script>

<script>
function setToday() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
}
setToday();

function toLocalTimeString(h) {
  const hr = Math.floor(h);
  const min = Math.floor((h - hr) * 60);
  return `${String(hr).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
}

document.getElementById('inputForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  const dateStr = document.getElementById('date').value;
  const dateObj = new Date(dateStr + "T00:00:00");

  const obs = {
    year: dateObj.getFullYear(),
    month: dateObj.getMonth() + 1,
    day: dateObj.getDate(),
    hours: 0,
    minutes: 0,
    seconds: 0,
    tz: 0,       // ✅ Correct property
    dst: 0,      // ✅ Already correct
    lon: lon,
    lat: lat
  };

  // Compute Moonrise/Moonset
  const riseSet = moonrise(obs);
  let riseSetText = '';
  if (riseSet[0] >= 0) riseSetText += `Moonrise: ${toLocalTimeString(riseSet[0])} `;
  else riseSetText += `Moonrise: Not found `;
  if (riseSet[1] >= 0) riseSetText += `Moonset: ${toLocalTimeString(riseSet[1])}`;
  else riseSetText += `Moonset: Not found`;
  document.getElementById('riseSetText').innerText = riseSetText;

  // Azimuth & Elevation Plot
  const azimuths = [], elevations = [], labels = [];
  for (let h = 0; h <= 24; h += 1) {
    obs.hours = h;
    obs.minutes = 0;
    obs.seconds = 0;
    const moon = MoonPos(obs);
    azimuths.push(moon[4]);
    elevations.push(moon[3]);
    labels.push(`${h}:00`);
  }

  const ctx = document.getElementById('azElChart').getContext('2d');
  if (window.moonChart) window.moonChart.destroy(); // Reset if chart already exists

  window.moonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Azimuth (°)',
          data: azimuths,
          borderColor: 'blue',
          yAxisID: 'y',
        },
        {
          label: 'Elevation (°)',
          data: elevations,
          borderColor: 'green',
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: 'Azimuth' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: 'Elevation' }
        }
      },
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Moon Azimuth and Elevation Over 24h' }
      }
    }
  });
});
</script>

</body>
</html>
