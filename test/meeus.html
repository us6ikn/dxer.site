<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Az/El & Rise/Set Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
    }
    label, input {
      margin: 0.5em;
    }
  </style>
</head>
<body>

<h2>Moon Position Calculator</h2>

<form id="inputForm">
  <label>Latitude: <input type="number" step="0.01" id="lat" value="40.0"></label>
  <label>Longitude: <input type="number" step="0.01" id="lon" value="-74.0"></label>
  <label>Date: <input type="date" id="date" value=""></label>
  <button type="submit">Calculate</button>
</form>

<h3>Moonrise & Moonset</h3>
<p id="riseSetText">No data yet.</p>

<canvas id="azElChart" width="800" height="400"></canvas>

<!-- External JS dependencies -->
<script src="observer.js"></script>
<script src="datetime.js"></script>
<script src="sun.js"></script>
<script src="moon.js"></script>
<script src="planets.js"></script>
<script src="stars.js"></script>
<script src="separation.js"></script>
<script src="util.js"></script>
<script src="math.js"></script>

<script>
function setToday() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
}
setToday();

// Converts fractional hours (e.g. 14.5) into HH:MM:SS format string
function toLocalTimeString(h) {
  if (h < 0) return 'Not found';
  const hr = Math.floor(h);
  const min = Math.floor((h - hr) * 60);
  const sec = Math.floor(((h - hr) * 60 - min) * 60);
  return `${String(hr).padStart(2, '0')}:${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

document.getElementById('inputForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  const dateStr = document.getElementById('date').value;

  if (!dateStr) {
    alert("Please select a valid date.");
    return;
  }

  const dateObj = new Date(dateStr + "T00:00:00");

  // Calculate local timezone offset in hours (e.g. -4 for EDT)
  const tzOffsetHours = -dateObj.getTimezoneOffset() / 60;

  const obs = {
    year: dateObj.getFullYear(),
    month: dateObj.getMonth() + 1,
    day: dateObj.getDate(),
    hours: 0,
    minutes: 0,
    seconds: 0,
    tz: tzOffsetHours,  // Use local timezone offset here
    dst: 0,             // Assuming no DST offset needed or handled inside functions
    lon: lon,
    lat: lat
  };

  // Compute Moonrise/Moonset
  const riseSet = moonrise(obs);
  console.log('moonrise result:', riseSet);

  let riseSetText = '';
  riseSetText += `Moonrise: ${toLocalTimeString(riseSet[0])} `;
  riseSetText += `Moonset: ${toLocalTimeString(riseSet[1])}`;
  document.getElementById('riseSetText').innerText = riseSetText;

  // Azimuth & Elevation Plot for every hour of the day
  const azimuths = [], elevations = [], labels = [];
  for (let h = 0; h <= 24; h += 1) {
    obs.hours = h;
    obs.minutes = 0;
    obs.seconds = 0;
    const moon = MoonPos(obs);
    azimuths.push(moon[4]);
    elevations.push(moon[3]);
    labels.push(`${h}:00`);
  }

  const ctx = document.getElementById('azElChart').getContext('2d');
  if (window.moonChart) window.moonChart.destroy();

  window.moonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Azimuth (째)',
          data: azimuths,
          borderColor: 'blue',
          yAxisID: 'y',
          fill: false,
        },
        {
          label: 'Elevation (째)',
          data: elevations,
          borderColor: 'green',
          yAxisID: 'y1',
          fill: false,
        }
      ]
    },
    options: {
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: 'Azimuth (째)' },
          min: 0,
          max: 360,
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: 'Elevation (째)' },
          min: -90,
          max: 90,
        }
      },
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Moon Azimuth and Elevation Over 24h' }
      }
    }
  });

});
</script>

</body>
</html>
