<!DOCTYPE html>
<html lang="en">
    <head>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-7YST3WTEH3"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-7YST3WTEH3');
        </script>
      <meta charset="UTF-8">
      <title>Awards – SA5IKN</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- Standard favicon -->
      <link rel="icon" type="image/png" sizes="32x32" href="https://dxer.site/assets/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="https://dxer.site/assets/favicon-16x16.png">
      <link rel="shortcut icon" href="https://dxer.site/assets/favicon.ico">
      <!-- Apple Touch Icon -->
      <link rel="apple-touch-icon" href="https://dxer.site/assets/apple-touch-icon.png">
      <!-- Android/Chrome Icons -->
      <link rel="icon" type="image/png" sizes="192x192" href="https://dxer.site/assets/android-chrome-192x192.png">
      <link rel="icon" type="image/png" sizes="512x512" href="https://dxer.site/assets/android-chrome-512x512.png">
      <!-- Web App Manifest -->
      <link rel="manifest" href="https://dxer.site/assets/site.webmanifest">
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://dxer.site/eme-observer/a.ob.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
      <style>
          .profile-image {
                pointer-events: none;
                user-select: none;
              }
      </style>
      <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { text-align: center; font-size: 16px; font-weight: bold; color: black; }
          .chart-container { position: relative; margin-bottom: 5px; width: 800px; height: 200px; }
          .y-label-left { position: absolute; left: 20px; top: 25px; color: #fa4d56; font-weight: bold; font-size: 12px; }
          .y-label-right { position: absolute; right: 20px; top: 25px; color: #1192e8; font-weight: bold; font-size: 12px; }
          .we-label { position: absolute; left: 30px; top: 46px; color: black; font-size: 8px; }
          #explanation { margin-top: 20px; font-size: 12px; }
          #explanation p { margin: 5px 0; }
          #explanation span { font-size: 14px; margin-right: 5px; }
          #year-selector { text-align: center; margin-bottom: 20px; }
          #year-selector label { font-size: 14px; margin-right: 10px; }
          #year-selector input { width: 100px; padding: 5px; font-size: 14px; }
      </style>
    </head>
    <body class="bg-gray-50 text-gray-800">
        
        <header class="bg-white shadow relative">
          <!-- Your existing header content remains unchanged -->
          <div class="container mx-auto p-4 flex flex-col md:flex-row md:items-center md:justify-between relative">
            <!-- Profile Info -->
            <div class="flex items-start space-x-4">
                <img src="https://dxer.site/img/profile.jpg" alt="Profile" class="profile-image w-20 h-20 rounded-lg flex-shrink-0" />
              <div class="flex flex-col">
                <h1 class="text-lg md:text-xl font-bold leading-tight">SA5IKN – Amateur Radio Station</h1>
                <p class="text-sm text-gray-600">a.k.a MØSKN, US6IKN, EI6KC</p>
                <div class="flex flex-wrap gap-1 mt-1">
                  <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded">EME</span>
                  <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-0.5 rounded">SAT</span>
                  <span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">HF</span>
                  <span class="text-xs font-semibold bg-purple-100 text-purple-800 px-2 py-0.5 rounded">VHF</span>
                  <span class="text-xs font-semibold bg-pink-100 text-pink-800 px-2 py-0.5 rounded">UHF</span>
                  <span class="text-xs font-semibold bg-gray-200 text-gray-800 px-2 py-0.5 rounded">SHF</span>
                </div>
                <div class="flex items-center space-x-4 mt-2">
                  <a href="https://x.com/M0SKN_SA5IKN" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-sm text-blue-600 hover:underline">
                    <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M20.87 4.13c-.7.31-1.46.52-2.26.61a4.03 4.03 0 0 0 1.78-2.22 8.1 8.1 0 0 1-2.56.98 4.02 4.02 0 0 0-6.84 3.66A11.43 11.43 0 0 1 3.15 3.1a4 4 0 0 0 1.24 5.37 3.99 3.99 0 0 1-1.83-.5v.05a4.03 4.03 0 0 0 3.23 3.94 4.02 4.02 0 0 1-1.82.07 4.03 4.03 0 0 0 3.76 2.8A8.09 8.09 0 0 1 2 18.57 11.4 11.4 0 0 0 8.29 20.5c7.55 0 11.68-6.26 11.68-11.68 0-.18-.01-.36-.02-.53a8.35 8.35 0 0 0 2.05-2.13l-.01-.03z"/>
                    </svg>
                    Follow on X
                  </a>
                  <a href="https://www.facebook.com/DXerMax/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-sm text-blue-600 hover:underline">
                    <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M22 12c0-5.522-4.477-10-10-10S2 6.478 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.988h-2.54v-2.89h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/>
                    </svg>
                    Follow on Facebook
                  </a>
                </div>
              </div>
            </div>
            <!-- Mobile Menu Button -->
            <div class="absolute top-4 right-4 md:hidden">
              <button id="menu-toggle" class="text-gray-700 text-2xl focus:outline-none">
                ☰
              </button>
            </div>
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex md:ml-auto space-x-4 text-sm font-semibold mt-4 md:mt-0">
              <a href="index.html">Home</a>
              <a href="about.html">About</a>
              <a href="https://dxer.site/eme-observer/">EME Planner - 10GHz EME Map</a>
              <a href="https://dxer.site/greencube-observer.html">Satellite Maps</a>
              <div class="relative group">
                <div class="text-sm font-semibold focus:outline-none cursor-pointer">Tools ▾</div>
                <div class="absolute left-0 mt-2 w-56 bg-white shadow-lg rounded opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50" onmouseenter="this.classList.add('opacity-100','visible')" onmouseleave="this.classList.remove('opacity-100','visible')">
                  <a href="https://dxer.site/eme-observer/" class="block px-4 py-2 hover:bg-gray-100">EME Observer - 10GHz</a>
                  <a href="https://dxer.site/sa5ikn-qrb-calculator/" class="block px-4 py-2 hover:bg-gray-100">QRB Calculator - Azimuth Finder</a>
                  <a href="https://dxer.site/greencube-observer.html" class="block px-4 py-2 hover:bg-gray-100">GreenCube Observer</a>
                  <a href="https://dxer.site/leo-satellite-observer.html" class="block px-4 py-2 hover:bg-gray-100">LEO Satellite Observer</a>
                  <a href="https://dxer.site/qo-100-satellite-observer.html" class="block px-4 py-2 hover:bg-gray-100">QO-100 Satellite Observer</a>
                </div>
              </div>
              <a href="awards.html" class="text-blue-600">Awards</a>
              <a href="links.html">Links</a>
              <a href="contact.html">Contact & QSL</a>
            </nav>
          </div>
          <!-- Mobile Navigation -->
          <nav id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200">
            <ul class="flex flex-col space-y-2 p-4 text-sm font-semibold">
              <li><a href="index.html">Home</a></li>
              <li><a href="about.html">About</a></li>
              <li><a href="https://dxer.site/eme-observer/">EME Planner - 10GHz EME Map</a></li>
              <li><a href="https://dxer.site/greencube-observer.html">Satellite Maps</a></li>
              <li class="relative">
                <button onclick="toggleMobileSubmenu()" class="w-full text-left text-gray-800 font-semibold flex items-center justify-between">
                  Tools
                  <svg id="submenu-arrow" class="w-4 h-4 ml-2 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <ul id="mobile-tools-submenu" class="ml-4 mt-1 space-y-1 hidden">
                  <li><a href="https://dxer.site/eme-observer/" class="text-blue-600">EME Observer - 10GHz</a></li>
                  <li><a href="https://dxer.site/sa5ikn-qrb-calculator/" class="text-blue-600">QRB Calculator - Azimuth Finder</a></li>
                  <li><a href="https://dxer.site/greencube-observer.html" class="text-blue-600">GreenCube Observer</a></li>
                  <li><a href="https://dxer.site/leo-satellite-observer.html" class="text-blue-600">LEO Satellite Observer</a></li>
                  <li><a href="https://dxer.site/qo-100-satellite-observer.html" class="text-blue-600">QO-100 Satellite Observer</a></li>
                </ul>
              </li>
              <li><a href="https://dxer.site/awards.html" class="text-blue-600">Awards</a></li>
              <li><a href="https://dxer.site/links.html">Links</a></li>
              <li><a href="contact.html">Contact & QSL</a></li>
            </ul>
          </nav>
          <script>
              document.addEventListener('DOMContentLoaded', function() {
                        const profileImage = document.querySelector('.profile-image');
                        if (profileImage) {
                          profileImage.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                          });
                        }
                      });
            document.getElementById("menu-toggle").addEventListener("click", function () {
              const menu = document.getElementById("mobile-menu");
              menu.classList.toggle("hidden");
            });
            function toggleMobileSubmenu() {
              const submenu = document.getElementById("mobile-tools-submenu");
              const arrow = document.getElementById("submenu-arrow");
              submenu.classList.toggle("hidden");
              arrow.classList.toggle("rotate-180");
            }
          </script>
        </header>
        <body class="bg-gray-50 text-gray-800">
          <main class="max-w-3xl mx-auto p-4">
            <h1 class="text-2xl font-bold mb-6">Awards</h1>
            <div itemprop="articleBody">
                <div id="year-selector">
                    <label for="year-input">Select Year:</label>
                    <input type="number" id="year-input" value="2026" min="1900" max="2100">
                </div>
                <h1 id="chart-title">MOON EPHEMERIS OVERVIEW FOR THE YEAR 2026, by SA5IKN</h1>
                <div class="chart-container">
                    <span class="y-label-left">Declination (°)</span>
                    <span class="y-label-right">Extra-Loss (dB)</span>
                    <span class="we-label">WE:</span>
                    <canvas id="chart1"></canvas>
                </div>
                <div class="chart-container">
                    <span class="y-label-left">Declination (°)</span>
                    <span class="y-label-right">Extra-Loss (dB)</span>
                    <span class="we-label">WE:</span>
                    <canvas id="chart2"></canvas>
                </div>
                <div class="chart-container">
                    <span class="y-label-left">Declination (°)</span>
                    <span class="y-label-right">Extra-Loss (dB)</span>
                    <span class="we-label">WE:</span>
                    <canvas id="chart3"></canvas>
                </div>
                <div class="chart-container">
                    <span class="y-label-left">Declination (°)</span>
                    <span class="y-label-right">Extra-Loss (dB)</span>
                    <span class="we-label">WE:</span>
                    <canvas id="chart4"></canvas>
                </div>
                <div id="explanation">
                    <h3>Explanation:</h3>
                    <p><span style="color: grey;">■</span> Vertical grey bars show the days where the sky temp is high and could degrade the system temperature.</p>
                    <p><span style="color: orange;">■</span> Vertical orange bars show the days where the moon is close to the sun (&lt;10°), near the new moon dates.</p>
                    <p><span style="color: #1192e8;">―</span> Extra-loss is the additional range loss in dB compared to the minimum pathloss at Moon perigee.</p>
                    <p><span style="color: #fa4d56;">―</span> The declination is plotted as red curve and weekends (WE) are marked at the top of the ephemeris graph.</p>
                </div>
                <script>
                    const PERIGEE_DISTANCE_KM = 356352.93;
                    const COLOR_DECLINATION = '#fa4d56';
                    const COLOR_LOSS = '#1192e8';
                    const GC_RA_HOURS = 17 + 45/60 + 40/3600; // Galactic Center RA in hours
                    const GC_DEC = -(29 + 0/60 + 28/3600); // Galactic Center Dec in degrees

                    // Store Chart.js instances to destroy them when updating
                    let charts = [null, null, null, null];

                    // Function to compute angular separation between two equatorial coordinates
                    function angularSeparation(ra1, dec1, ra2, dec2) {
                        const ra1Rad = ra1 * Math.PI / 12;
                        const dec1Rad = dec1 * Math.PI / 180;
                        const ra2Rad = ra2 * Math.PI / 12;
                        const dec2Rad = dec2 * Math.PI / 180;
                        const cosSep = Math.sin(dec1Rad) * Math.sin(dec2Rad) +
                                       Math.cos(dec1Rad) * Math.cos(dec2Rad) * Math.cos(ra1Rad - ra2Rad);
                        const sepRad = Math.acos(Math.min(Math.max(cosSep, -1), 1));
                        return sepRad * 180 / Math.PI;
                    }

                    function computeMoonData(start, end) {
                        const data = [];
                        function formatDateNatural(date) {
                            const year = date.getUTCFullYear();
                            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                            const day = String(date.getUTCDate()).padStart(2, '0');
                            const hours = String(date.getUTCHours()).padStart(2, '0');
                            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                            return `${year}-${month}-${day} ${hours}:${minutes} UTC`;
                        }

                        for (let dt = new Date(start); dt <= end; dt.setUTCDate(dt.getUTCDate() + 1)) {
                            [0, 12].forEach(hour => {
                                const dtSample = new Date(dt);
                                dtSample.setUTCHours(hour, 0, 0, 0);
                                try {
                                    const astroTime = Astronomy.MakeTime(dtSample);
                                    const libration = Astronomy.Libration(astroTime);
                                    const dist_km = libration.dist_km;
                                    const moonGeo = Astronomy.GeoVector(Astronomy.Body.Moon, astroTime, true);
                                    const sunGeo = Astronomy.GeoVector(Astronomy.Body.Sun, astroTime, true);
                                    const moonEq = Astronomy.EquatorFromVector(moonGeo);
                                    const sunEq = Astronomy.EquatorFromVector(sunGeo);
                                    const dec = moonEq.dec;
                                    const moon_ra = moonEq.ra;
                                    const extra_loss = 40 * Math.log10(dist_km / PERIGEE_DISTANCE_KM);
                                    const sun_sep = angularSeparation(moon_ra, dec, sunEq.ra, sunEq.dec);
                                    const gc_sep = angularSeparation(moon_ra, dec, GC_RA_HOURS, GC_DEC);
                                    data.push({
                                        date: new Date(dtSample),
                                        dateStr: formatDateNatural(dtSample),
                                        dec,
                                        dist: dist_km,
                                        extra_loss,
                                        sun_sep,
                                        gc_sep
                                    });
                                } catch (e) {
                                    console.warn(`Error computing data for ${dtSample.toISOString()}: ${e.message}`);
                                }
                            });
                        }
                        data.sort((a, b) => a.date - b.date);
                        return data;
                    }

                    function createAnnotations(data, start, end) {
                        const annotations = [];
                        function dateToStrWithHours(date) {
                            return date.toISOString().slice(0, 16);
                        }
                        function interpolateCrossingTime(d1, d2, sep1, sep2, threshold) {
                            const t1 = d1.date.getTime();
                            const t2 = d2.date.getTime();
                            const fraction = (threshold - sep1) / (sep2 - sep1);
                            const interpolatedTime = t1 + fraction * (t2 - t1);
                            return new Date(interpolatedTime);
                        }

                        // Orange bars: Moon-Sun <10°
                        let is_close_sun = data.map(d => d.sun_sep < 10);
                        let startIdx = null;
                        for (let i = 0; i < data.length; i++) {
                            if (is_close_sun[i] && startIdx === null) {
                                startIdx = i;
                            } else if (!is_close_sun[i] && startIdx !== null) {
                                let barStart = data[startIdx].date;
                                let barEnd = data[i - 1].date;
                                if (startIdx > 0 && data[startIdx - 1].sun_sep >= 10) {
                                    barStart = interpolateCrossingTime(data[startIdx - 1], data[startIdx], data[startIdx - 1].sun_sep, data[startIdx].sun_sep, 10);
                                }
                                if (i < data.length && data[i].sun_sep >= 10) {
                                    barEnd = interpolateCrossingTime(data[i - 1], data[i], data[i - 1].sun_sep, data[i].sun_sep, 10);
                                } else {
                                    barEnd = new Date(data[i - 1].date);
                                    barEnd.setUTCHours(barEnd.getUTCHours() + 12);
                                }
                                annotations.push({
                                    type: 'box',
                                    xScaleID: 'x',
                                    xMin: dateToStrWithHours(barStart),
                                    xMax: dateToStrWithHours(barEnd),
                                    yScaleID: 'yDec',
                                    yMin: -30,
                                    yMax: 30,
                                    backgroundColor: 'rgba(255, 165, 0, 0.4)',
                                    borderWidth: 0
                                });
                                startIdx = null;
                            }
                        }
                        if (startIdx !== null) {
                            let barStart = data[startIdx].date;
                            let barEnd = new Date(data[data.length - 1].date);
                            barEnd.setUTCHours(barEnd.getUTCHours() + 12);
                            if (startIdx > 0 && data[startIdx - 1].sun_sep >= 10) {
                                barStart = interpolateCrossingTime(data[startIdx - 1], data[startIdx], data[startIdx - 1].sun_sep, data[startIdx].sun_sep, 10);
                            }
                            annotations.push({
                                type: 'box',
                                xScaleID: 'x',
                                xMin: dateToStrWithHours(barStart),
                                xMax: dateToStrWithHours(barEnd),
                                yScaleID: 'yDec',
                                yMin: -30,
                                yMax: 30,
                                backgroundColor: 'rgba(255, 165, 0, 0.4)',
                                borderWidth: 0
                            });
                        }

                        // Grey bars: Moon-GC <10°
                        let is_high_temp = data.map(d => d.gc_sep < 10);
                        startIdx = null;
                        for (let i = 0; i < data.length; i++) {
                            if (is_high_temp[i] && startIdx === null) {
                                startIdx = i;
                            } else if (!is_high_temp[i] && startIdx !== null) {
                                let barStart = data[startIdx].date;
                                let barEnd = data[i - 1].date;
                                if (startIdx > 0 && data[startIdx - 1].gc_sep >= 10) {
                                    barStart = interpolateCrossingTime(data[startIdx - 1], data[startIdx], data[startIdx - 1].gc_sep, data[startIdx].gc_sep, 10);
                                }
                                if (i < data.length && data[i].gc_sep >= 10) {
                                    barEnd = interpolateCrossingTime(data[i - 1], data[i], data[i - 1].gc_sep, data[i].gc_sep, 10);
                                } else {
                                    barEnd = new Date(data[i - 1].date);
                                    barEnd.setUTCHours(barEnd.getUTCHours() + 12);
                                }
                                annotations.push({
                                    type: 'box',
                                    xScaleID: 'x',
                                    xMin: dateToStrWithHours(barStart),
                                    xMax: dateToStrWithHours(barEnd),
                                    yScaleID: 'yDec',
                                    yMin: -30,
                                    yMax: 30,
                                    backgroundColor: 'rgba(128, 128, 128, 0.4)',
                                    borderWidth: 0
                                });
                                startIdx = null;
                            }
                        }
                        if (startIdx !== null) {
                            let barStart = data[startIdx].date;
                            let barEnd = new Date(data[data.length - 1].date);
                            barEnd.setUTCHours(barEnd.getUTCHours() + 12);
                            if (startIdx > 0 && data[startIdx - 1].gc_sep >= 10) {
                                barStart = interpolateCrossingTime(data[startIdx - 1], data[startIdx], data[startIdx - 1].gc_sep, data[startIdx].gc_sep, 10);
                            }
                            annotations.push({
                                type: 'box',
                                xScaleID: 'x',
                                xMin: dateToStrWithHours(barStart),
                                xMax: dateToStrWithHours(barEnd),
                                yScaleID: 'yDec',
                                yMin: -30,
                                yMax: 30,
                                backgroundColor: 'rgba(128, 128, 128, 0.4)',
                                borderWidth: 0
                            });
                        }

                        // Month separators and labels
                        let month_start = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), 1));
                        while (month_start < end) {
                            const monthStr = dateToStrWithHours(month_start);
                            if (month_start.getTime() !== start.getTime() && month_start.getTime() !== end.getTime()) {
                                annotations.push({
                                    type: 'line',
                                    xScaleID: 'x',
                                    xMin: monthStr,
                                    xMax: monthStr,
                                    yScaleID: 'yDec',
                                    yMin: -30,
                                    yMax: 30,
                                    borderColor: 'gray',
                                    borderWidth: 1.5
                                });
                            }
                            const ndays = new Date(Date.UTC(month_start.getUTCFullYear(), month_start.getUTCMonth() + 1, 0)).getUTCDate();
                            const mid_month = new Date(Date.UTC(month_start.getUTCFullYear(), month_start.getUTCMonth(), Math.floor(ndays / 2)));
                            const midStr = dateToStrWithHours(mid_month);
                            annotations.push({
                                type: 'label',
                                xScaleID: 'x',
                                yScaleID: 'yDec',
                                xValue: midStr,
                                yValue: 38,
                                content: month_start.toLocaleString('default', { month: 'long' }),
                                font: { size: 8, weight: 'bold' },
                                color: 'black'
                            });
                            month_start = new Date(Date.UTC(month_start.getUTCFullYear(), month_start.getUTCMonth() + 1, 1));
                        }

                        // Weekend dashed lines and labels
                        let current = new Date(start.getTime());
                        while (current < end) {
                            const wd = current.getUTCDay();
                            const currentStr = dateToStrWithHours(current);
                            if (wd === 0 || wd === 6) {
                                annotations.push({
                                    type: 'line',
                                    xScaleID: 'x',
                                    xMin: currentStr,
                                    xMax: currentStr,
                                    yScaleID: 'yDec',
                                    yMin: -30,
                                    yMax: 30,
                                    borderColor: 'gray',
                                    borderWidth: 1.5,
                                    borderDash: [5, 5],
                                    borderDashOffset: 0
                                });
                                if (wd === 6) {
                                    const sunday = new Date(current.getTime());
                                    sunday.setUTCDate(sunday.getUTCDate() + 1);
                                    const label = `${current.getUTCDate()}/${sunday.getUTCDate()}`;
                                    const mid = new Date(current.getTime());
                                    mid.setUTCHours(12);
                                    const midStr = dateToStrWithHours(mid);
                                    annotations.push({
                                        type: 'label',
                                        xScaleID: 'x',
                                        yScaleID: 'yDec',
                                        xValue: midStr,
                                        yValue: 33,
                                        content: label,
                                        font: { size: 8 },
                                        color: 'black'
                                    });
                                }
                            }
                            current.setUTCDate(current.getUTCDate() + 1);
                        }
                        return annotations;
                    }

                    function createCharts(year) {
                        // Update the title
                        document.getElementById('chart-title').textContent = `MOON EPHEMERIS OVERVIEW FOR THE YEAR ${year}, by SA5IKN`;

                        // Define quarters for the selected year
                        const quarters = [
                            { start: new Date(Date.UTC(year, 0, 1)), end: new Date(Date.UTC(year, 3, 0)) },
                            { start: new Date(Date.UTC(year, 3, 1)), end: new Date(Date.UTC(year, 6, 0)) },
                            { start: new Date(Date.UTC(year, 6, 1)), end: new Date(Date.UTC(year, 9, 0)) },
                            { start: new Date(Date.UTC(year, 9, 1)), end: new Date(Date.UTC(year + 1, 0, 0)) }
                        ];

                        quarters.forEach((quarter, index) => {
                            // Destroy existing chart if it exists
                            if (charts[index]) {
                                charts[index].destroy();
                                charts[index] = null;
                            }

                            const data = computeMoonData(quarter.start, quarter.end);
                            if (!data || data.length === 0) {
                                console.warn(`No data for quarter ${index + 1}`);
                                return;
                            }
                            const annotations = createAnnotations(data, quarter.start, quarter.end);
                            const canvas = document.getElementById(`chart${index + 1}`);
                            if (!canvas) {
                                console.error(`Canvas element chart${index + 1} not found`);
                                return;
                            }
                            const ctx = canvas.getContext('2d');

                            charts[index] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    datasets: [
                                        {
                                            label: 'Declination',
                                            data: data.map(d => ({ x: d.date, y: d.dec })),
                                            borderColor: COLOR_DECLINATION,
                                            borderWidth: 1.5,
                                            pointRadius: 0,
                                            yAxisID: 'yDec'
                                        },
                                        {
                                            label: 'Extra Loss',
                                            data: data.map(d => ({ x: d.date, y: d.extra_loss })),
                                            borderColor: COLOR_LOSS,
                                            borderWidth: 1.5,
                                            pointRadius: 0,
                                            yAxisID: 'yLoss'
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            type: 'time',
                                            time: { unit: 'day', parser: 'yyyy-MM-dd\'T\'HH:mm', displayFormats: { day: 'MMM d' } },
                                            min: quarter.start,
                                            max: quarter.end,
                                            position: 'top',
                                            ticks: { display: false },
                                            grid: { display: false },
                                            border: { display: false }
                                        },
                                        yDec: {
                                            min: -30,
                                            max: 30,
                                            position: 'left',
                                            ticks: { color: COLOR_DECLINATION, font: { size: 9 }, drawTicks: true, tickLength: 10 },
                                            grid: { display: true, color: 'rgba(0,0,0,0.3)', borderDash: [2,2], drawBorder: false },
                                            border: { display: true, color: COLOR_DECLINATION, width: 1.2 }
                                        },
                                        yLoss: {
                                            min: 0,
                                            max: 2.4,
                                            reverse: true,
                                            position: 'right',
                                            ticks: {
                                                color: COLOR_LOSS,
                                                font: { size: 9 },
                                                drawTicks: true,
                                                tickLength: 10,
                                                stepSize: 0.4,
                                                callback: function(value) {
                                                    const allowedTicks = [0, 0.4, 0.8, 1.2, 1.6, 2, 2.4];
                                                    if (allowedTicks.includes(Number(value.toFixed(1)))) {
                                                        return value.toFixed(1);
                                                    }
                                                    return null;
                                                }
                                            },
                                            grid: { display: false, drawBorder: false },
                                            border: { display: true, color: COLOR_LOSS, width: 1.2 }
                                        }
                                    },
                                    interaction: {
                                        mode: 'index',
                                        intersect: false,
                                        axis: 'x'
                                    },
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            enabled: false,
                                            displayColors: false,
                                            external: function(context) {
                                                const tooltipModel = context.tooltip;
                                                const chart = context.chart;
                                                const canvas = chart.canvas;
                                                const container = canvas.parentNode;
                                                const tooltipId = 'chartjs-tooltip-' + canvas.id;
                                                let tooltipEl = container.querySelector('#' + tooltipId);
                                                if (!tooltipEl) {
                                                    tooltipEl = document.createElement('div');
                                                    tooltipEl.id = tooltipId;
                                                    tooltipEl.className = 'chartjs-tooltip';
                                                    tooltipEl.style.position = 'absolute';
                                                    tooltipEl.style.pointerEvents = 'none';
                                                    tooltipEl.style.background = 'rgba(255,255,255,0.98)';
                                                    tooltipEl.style.border = '1px solid #ccc';
                                                    tooltipEl.style.borderRadius = '4px';
                                                    tooltipEl.style.padding = '6px 8px';
                                                    tooltipEl.style.fontSize = '11px';
                                                    tooltipEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';
                                                    tooltipEl.style.transition = 'opacity 0.04s ease';
                                                    tooltipEl.style.whiteSpace = 'nowrap';
                                                    tooltipEl.style.zIndex = 1000;
                                                    tooltipEl.style.opacity = '0';
                                                    container.appendChild(tooltipEl);
                                                }
                                                if (tooltipModel.opacity === 0 || !tooltipModel.dataPoints || tooltipModel.dataPoints.length === 0) {
                                                    tooltipEl.style.opacity = '0';
                                                    return;
                                                }
                                                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                                if (dataIndex == null || !data[dataIndex]) {
                                                    tooltipEl.style.opacity = '0';
                                                    return;
                                                }
                                                const d = data[dataIndex];
                                                tooltipEl.innerHTML = `
                                                    <div style="font-weight:700;margin-bottom:4px;">${d.dateStr}</div>
                                                    <div style="color:${COLOR_DECLINATION};margin-bottom:2px;">Declination: ${d.dec.toFixed(2)}°</div>
                                                    <div style="color:${COLOR_LOSS};margin-bottom:2px;">Extra Loss: ${d.extra_loss.toFixed(2)} dB</div>
                                                    <div style="color:#000;margin-bottom:2px;">Distance: ${d.dist.toFixed(0)} km</div>
                                                    <div style="color:orange;margin-bottom:2px;">Moon-Sun Sep: ${d.sun_sep.toFixed(2)}°</div>
                                                    <div style="color:gray;">Moon-GC Sep: ${d.gc_sep.toFixed(2)}°</div>
                                                `;
                                                const caretX = tooltipModel.caretX;
                                                const caretY = tooltipModel.caretY;
                                                tooltipEl.style.left = caretX + 'px';
                                                tooltipEl.style.top = caretY + 'px';
                                                tooltipEl.style.transform = 'translate(-50%, -120%)';
                                                tooltipEl.style.opacity = '1';
                                            }
                                        },
                                        annotation: {
                                            clip: false,
                                            annotations: annotations
                                        }
                                    },
                                    layout: {
                                        padding: { top: 50, bottom: 10, left: 20, right: 30 }
                                    },
                                    elements: { line: { tension: 0 } }
                                }
                            });
                        });
                    }

                    // Initialize charts with default year
                    createCharts(2026);

                    // Add event listener for year input
                    document.getElementById('year-input').addEventListener('change', (event) => {
                        const year = parseInt(event.target.value);
                        if (year >= 1900 && year <= 2100) {
                            createCharts(year);
                        } else {
                            alert('Please enter a year between 1900 and 2100');
                            event.target.value = 2026;
                            createCharts(2026);
                        }
                    });
                </script>
            </div>
          </main>

          <footer class="bg-gray-100 text-center p-4 mt-10 text-sm text-gray-600">
            © All rights reserved. SA5IKN M0SKN US6IKN EI6KC, 2025
          </footer>
        </body>

</html>
