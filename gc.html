<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blinking Markers on Google Maps</title>
  
  <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

    #map {
      height: 100%;
    }
    .blinking-marker {
      /* Set the marker icon to the URL of your blinking gif */
      background-image: url(img/rover.gif);
      /* Set the width and height of the marker */
      width: 20px;
      height: 20px;
      /* Set the background position to display the first frame of the gif */
      background-position: 0 0;
      /* Set the animation to cycle through the frames of the gif */
      animation: blink 1s steps(2) infinite;
    }
    /* Define the animation */
    @keyframes blink {
      50% {
        background-position: -32px 0;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Define the URL of your blinking gif
    const BLINKING_GIF_URL = 'img/rover1.gif?v=1';

    // Define the callback function that initializes the Google Map
    function initMap() {
      // Load the announcements data from the file
      fetch('announcements_filtered.txt')
        .then(response => response.text())
        .then(data => {
          // Split the data into individual announcements
          const announcements = data.trim().split('\n');

          // Create a new Google Map
          const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: { lat: 38.0, lng: -82.0 },
          });

          let openInfoWindow = null; // keep track of the currently open info window

          // Loop through the announcements and create markers for each one
          for (let i = 0; i < announcements.length; i++) {
            const announcement = announcements[i];

            // Extract the coordinates and time from the announcement
                        const coordinates = announcement.match(/Coordinates: \((.*), (.*)\)/);
                        const timeString = announcement.match(/Time: (.*)/)[1];

                        if (!coordinates || !timeString) {
                          continue;
                        }

                        const lat = parseFloat(coordinates[1]);
                        const lng = parseFloat(coordinates[2]);
                        const time = new Date(timeString);

                        // Check if the time is in the future
                        if (time <= new Date()) {
                          continue;
                        }
            const lat = parseFloat(coordinates[1]);
            const lng = parseFloat(coordinates[2]);

            // Extract the callsign from the announcement
            const callsign = announcement.match(/Callsign: ([^,]*)/)[1];

            // Create a new marker with the blinking icon
            const marker = new google.maps.Marker({
              position: { lat, lng },
              map,
              icon: BLINKING_GIF_URL,
              optimized: false, // disable marker animation optimization
            });

            // Add a listener to the marker
            marker.addListener('click', () => {
              // Close the currently open info window
              if (openInfoWindow) {
                openInfoWindow.close();
              }

              // Create an info window with the callsign and hyperlink to https://hams.at/alerts
              const infoWindow = new google.maps.InfoWindow({
                content: `<div><a href="https://hams.at/alerts" target="_blank">${callsign}</a></div>`,
              });

              // Open the info window on the marker and update the currently open info window
              infoWindow.open(map, marker);
              openInfoWindow = infoWindow;
            });
          }
        });
    }

  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPRWRoTRhE5TddxBITIhBcKjdQpz2CXRs&callback=initMap"></script>
</body>
</html>
