<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7YST3WTEH3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7YST3WTEH3');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="GreenCube Observer Leaderboard IO-117" />
  <meta name="author" content="https://dxer.site" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <title>GreenCube Observer Leaderboard</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    html,body { height:100%; margin:0; font-family: 'Inter', Arial, sans-serif; }

    .floating {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background-color: rgba(255,255,255,0.95);
      padding: 14px 18px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.35);
      min-width: 220px;
    }
    .floating h2 { display:flex; align-items:flex-start; font-weight:700; font-size:16px; margin:0 0 10px 0; letter-spacing:0.5px; }
    .floating h2 img { width:28px; height:28px; margin-right:6px; margin-top:2px; }
    .title-text { display:flex; flex-direction:column; }
    .title-line{ display:flex; align-items:baseline; }
    .title-main{ font-size:16px; font-weight:700; }
    .title-sub{ font-size:11px; font-weight:500; text-align:right; margin-top:-2px; color:#333; }

    .observer-buttons { display:flex; gap:5px; margin-top:10px; flex-wrap:wrap; }
    .observer-buttons button {
      background-color:#0078d4; color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;
      font-size:12px; font-weight:600; transition:background 0.15s ease;
    }
    .observer-buttons button:hover { background-color:#005fa3; }

    #map { width: 100%; height: 60vh; min-height: 360px; }
    .page-inner { max-width:1200px; margin:16px auto; padding:0 16px; }

    #leaderboard { margin-top: 18px; }
    #leaderboard h2 { font-size:18px; color:#333; margin:0 0 8px 0; display:flex; align-items:center; gap:8px; }
    #leaderboard h2 span { font-weight:500; font-size:13px; color:#666; }
    #leaderboard table {
      width:100%;
      border-collapse:collapse;
      box-shadow:0 4px 8px rgba(0,0,0,0.06);
      border-radius:6px;
      overflow:hidden;
      margin-top:8px;
    }
    #leaderboard th, #leaderboard td {
      padding:10px 12px;
      border-bottom:1px solid #f2f2f2;
      text-align:left;
      font-size:13px;
    }
    #leaderboard th { background:#f7f7f7; font-weight:700; text-transform:uppercase; color:#333; font-size:12px; }
    #leaderboard tbody tr:nth-child(even) { background:#fafafa; }
    #leaderboard tbody tr:hover { background:#f0f7ff; }

    #backButton {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1100;
      background: transparent;
      border: none;
      text-decoration: none;
      color: #333;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      padding:8px;
      border-radius:6px;
    }
    #backButton img { width:20px; height:20px; }

    .leaflet-popup-content { font-family: Inter, Arial, sans-serif; font-size:13px; }

    @media (max-width:720px){
      .floating { left: 10px; right: 10px; min-width: auto; top: 12px; padding:10px; }
      #map { height: 50vh; }
      .observer-buttons button { padding:6px 8px; font-size:11px; }
      #leaderboard th, #leaderboard td { padding:8px; font-size:12px; }
    }
  </style>
</head>
<body>

  <div class="floating" aria-hidden="false">
    <h2>
      <img src="img/gclogo.png" alt="GreenCube logo">
      <div class="title-text">
        <div class="title-sub">by SA5IKN</div>
        <div class="title-line"><span class="title-main">GreenCube Observer</span></div>
      </div>
    </h2>

    <div class="observer-buttons">
      <button onclick="window.open('https://dxer.site/greencube-observer.html','_self')">Map</button>
      <button onclick="window.open('https://dxer.site/greencube-io117-statistics-dxcc.html','_self')">DXCC</button>
      <button onclick="window.open('https://dxer.site/greencube-io117-statistics-grids.html','_self')">Grids</button>
      <button onclick="window.open('https://dxer.site/greencube-io117-statistics-stations.html','_self')">Stations</button>
      <button onclick="window.open('https://dxer.site/greencube-leaderboard.html','_self')">Data</button>
    </div>
  </div>

  <div id="map"></div>

  <div class="page-inner">
    <div id="leaderboard">
      <h2>Open Data Contributors Leaderboard <span>(last 7 days)</span></h2>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Observer</th>
              <th>Continent</th>
              <th>Observations</th>
              <th>Contribution</th>
              <th>Grid</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const LINE_REGEX = /Rank:\s*(\d+),\s*Observer:\s*([^,]+),\s*Cont:\s*([^,]+),\s*Observations:\s*(\d+),\s*Percentage:\s*([\d.]+)%,\s*Grid Locator:\s*([^,]+),\s*Coordinates:\s*\(\s*([-\d.]+)\s*,\s*([-\d.]+)\s*\)/;

    fetch('leaderboard.txt')
      .then(r => r.text())
      .then(raw => {
        const lines = raw.trim().split(/\r?\n/).filter(Boolean);
        const rows = [];
        const markers = [];

        lines.forEach(line => {
          const m = LINE_REGEX.exec(line);
          if (!m) return;
          const rank = parseInt(m[1], 10);
          const observer = m[2].trim();
          const continent = m[3].trim();
          const observations = parseInt(m[4], 10);
          const percentage = parseFloat(m[5]);
          const grid = m[6].trim();
          const lat = parseFloat(m[7]);
          const lon = parseFloat(m[8]);

          rows.push({ rank, observer, continent, observations, percentage, grid, lat, lon });
          markers.push({ observer, continent, observations, percentage, grid, lat, lon });
        });

        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.rank}</td>
            <td>${r.observer}</td>
            <td>${r.continent}</td>
            <td>${r.observations.toLocaleString()}</td>
            <td>${r.percentage}%</td>
            <td>${r.grid}</td>
          </tr>
        `).join('');

        const map = L.map('map', {
          preferCanvas: true,
          zoomControl: false // we'll move it manually
        }).setView([20,0], 2);

        // Add zoom control bottom-right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        if (markers.length === 0) return;

        const bounds = [];
        markers.forEach(m => {
          const radius = Math.max(6, m.percentage * 1.2);
          const circle = L.circleMarker([m.lat, m.lon], {
            radius: radius,
            fillColor: '#d9534f',
            color: '#d9534f',
            fillOpacity: 0.6,
            weight: 0
          }).addTo(map);

          const popupHtml = `
            <div style="font-weight:700;margin-bottom:6px;">${m.observer}</div>
            <div>Continent: <strong>${m.continent}</strong></div>
            <div>Observations: <strong>${m.observations.toLocaleString()}</strong></div>
            <div>Contribution: <strong>${m.percentage}%</strong></div>
            <div>Grid: <strong>${m.grid}</strong></div>
          `;
          circle.bindPopup(popupHtml, { minWidth: 180 });
          circle.bindTooltip(`${m.observer} — ${m.percentage}%`, { direction: 'top', offset: [0, -radius] });

          bounds.push([m.lat, m.lon]);
        });

        if (bounds.length === 1) map.setView(bounds[0], 6);
        else map.fitBounds(bounds, { padding: [40, 40] });
      })
      .catch(err => console.error('Failed to load leaderboard.txt', err));
  </script>
</body>
</html>
