<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moon Sublunar Point Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/astronomy-engine@2.1.0/astronomy.min.js"></script>
  <script src="/leaflet/Leaflet.greatCircle.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #controls {
      padding: 8px;
      background: #222;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    #map { height: calc(100vh - 50px); width: 100vw; }
  </style>
</head>
<body>
  <div id="controls">
    <label>Date: <input type="date" id="date" /></label>
    <label>Time step:
      <input type="range" id="hour" min="0" max="47" step="1" value="0" />
      <span id="hourLabel">00:00</span>
    </label>
    <button id="update">Update Map</button>
  </div>

  <div id="map"></div>

  <script>
    let map, moonMarker = null, footprintCircle = null;

    function initMap() {
      map = L.map('map').setView([0, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 6,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      document.getElementById('update').addEventListener('click', updateMap);
      document.getElementById('hour').addEventListener('input', e => {
        const idx = parseInt(e.target.value, 10);
        const hour = Math.floor(idx / 2);
        const min = (idx % 2) ? 30 : 0;
        document.getElementById('hourLabel').textContent =
          `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
        updateMap();
      });

      // Set today as default
      const today = new Date();
      document.getElementById('date').value = today.toISOString().split('T')[0];
      updateMap();
    }

    function updateMap() {
      const selectedDate = document.getElementById('date').value;
      const index = parseInt(document.getElementById('hour').value, 10);
      const hour = Math.floor(index / 2);
      const minutes = (index % 2) ? 30 : 0;
      const utcTimeString = `${selectedDate}T${String(hour).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:00Z`;

      if (!selectedDate) return;
      const utcDate = new Date(utcTimeString);
      if (isNaN(utcDate.getTime())) return;

      try {
        const time = Astronomy.MakeTime(utcDate);
        const observer = new Astronomy.Observer(0, 0, 0);
        const moon = Astronomy.Equator(Astronomy.Body.Moon, time, observer, true, true);
        const libration = Astronomy.Libration(time);

        const raDeg = moon.ra * 15;
        const decDeg = moon.dec;
        let gastDeg = Astronomy.SiderealTime(time) * 15;
        gastDeg = ((gastDeg % 360) + 360) % 360;
        let lonDeg = raDeg - gastDeg;
        lonDeg = ((lonDeg + 180) % 360) - 180;
        const lat = decDeg;
        const lon = lonDeg;

        const earthRadiusKm = 6371;
        const safeRatio = Math.min(1, Math.max(-1, earthRadiusKm / (earthRadiusKm + libration.dist_km)));
        const theta_rad = Math.acos(safeRatio);
        const footprintRadius_m = earthRadiusKm * theta_rad * 1000;

        // ðŸ”¥ Remove all previous blue polygons or circles
        map.eachLayer(layer => {
          if (layer instanceof L.Polygon || layer instanceof L.Polyline || layer instanceof L.Circle) {
            if (layer.options && layer.options.color === '#0000FF') {
              map.removeLayer(layer);
            }
          }
        });

        // Remove previous marker
        if (moonMarker) {
          map.removeLayer(moonMarker);
          moonMarker = null;
        }

        // New marker
        const moonIcon = L.icon({
          iconUrl: 'images/moon-icon.png',
          iconSize: [48, 48],
          iconAnchor: [24, 24]
        });
        moonMarker = L.marker([lat, lon], {
          icon: moonIcon,
          title: `Moon Sublunar (${lat.toFixed(2)}Â°, ${lon.toFixed(2)}Â°)`
        }).addTo(map);

        // New great circle footprint
        footprintCircle = L.greatCircle([lat, lon], {
          radius: footprintRadius_m,
          color: '#0000FF',
          fillColor: '#0088FF',
          fillOpacity: 0.3,
          weight: 2,
          wrapElements: true,
          clipLat: 65,
          degStep: 0.5,
          maxCopies: -1
        }).addTo(map);

        map.panTo([lat, lon]);

        console.log(`Sublunar: lat=${lat.toFixed(4)} lon=${lon.toFixed(4)} radius_m=${Math.round(footprintRadius_m)}`);

      } catch (err) {
        console.error('Error calculating sublunar point:', err);
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
