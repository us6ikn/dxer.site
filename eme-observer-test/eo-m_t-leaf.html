<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EME Observer – Moon Footprint</title>
<link rel="stylesheet" href="/leaflet/leaflet.css" />
<script src="/leaflet/leaflet.js"></script>
<script src="/leaflet/Leaflet.greatCircle.js"></script>
<script src="a.ob.js"></script>
<style>
  html, body { margin:0; padding:0; height:100%; font-family:Arial; }
  #map { height:100dvh; width:100%; }
  #controls { position:absolute; top:10px; left:10px; z-index:1000; background:rgba(255,255,255,0.95); padding:12px; border-radius:8px; }
  #hour { width:320px; }
  button{padding:5px 10px; border-radius:4px; background:#007bff; color:white; border:none; cursor:pointer;}
  button:hover{background:#0056b3;}
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <div>
    <button id="prevDay">←</button>
    <input type="date" id="date" />
    <button id="nextDay">→</button>
  </div>
  <div style="margin-top:8px;">
    <input id="hour" type="range" min="0" max="47" step="1" value="0" />
    <div id="hour-value">Time (UTC): 00:00</div>
  </div>
</div>

<script>
let map, moonMarker, footprintCircle;

function initMap() {
  map = L.map('map', {
    center: [0,0],
    zoom: 2,
    scrollWheelZoom: true,
    zoomControl: false,
    worldCopyJump: true
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  updateMap();
}

function updateMap() {
  const selectedDate = document.getElementById('date').value;
  const index = parseInt(document.getElementById('hour').value,10);
  const hour = Math.floor(index/2).toString().padStart(2,'0');
  const minutes = (index%2)?30:0;
  const utcTimeString = `${selectedDate}T${hour}:${minutes}:00Z`;

  if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) return;

  const utcDate = new Date(utcTimeString);
  if (isNaN(utcDate.getTime())) return;

  try {
    const time = Astronomy.MakeTime(utcDate);
    const observer = new Astronomy.Observer(0,0,0);
    const moon = Astronomy.Equator(Astronomy.Body.Moon, time, observer, true, true);
    const libration = Astronomy.Libration(time);
    if (!moon || !libration) return;

    const raDeg = moon.ra*15;
    const decDeg = moon.dec;
    let gastDeg = Astronomy.SiderealTime(time)*15;
    gastDeg = ((gastDeg%360)+360)%360;
    let lonDeg = raDeg - gastDeg;
    lonDeg = ((lonDeg+180)%360)-180;
    const lat = decDeg;
    const lon = lonDeg;

    const earthRadiusKm = 6371;
    const D_moon = libration.dist_km;
    const safeRatio = Math.min(1, Math.max(-1, earthRadiusKm / (earthRadiusKm + D_moon)));
    const theta_rad = Math.acos(safeRatio);
    const footprintRadius_m = earthRadiusKm * theta_rad * 1000;

    // remove old
    if (moonMarker) { moonMarker.remove(); moonMarker=null; }
    if (footprintCircle) { footprintCircle.remove(); footprintCircle=null; }

    const moonIcon = L.icon({iconUrl:'images/moon-icon.png',iconSize:[48,48],iconAnchor:[24,24]});
    moonMarker = L.marker([lat, lon],{icon:moonIcon,title:`Moon Sublunar (${lat.toFixed(2)}°, ${lon.toFixed(2)}°)`}).addTo(map);

    // Use [lat, lon] array for plugin
    footprintCircle = L.greatCircle([lat, lon], {
      radius: footprintRadius_m,
      color:'#0000FF',
      fillColor:'#0088FF',
      fillOpacity:0.3,
      weight:2,
      wrapElements:true,
      clipLat:65,
      degStep:0.5,
      maxCopies:-1
    }).addTo(map);

    footprintCircle.bringToFront();
    map.panTo([lat, lon]);
    map.setZoom(2);

  } catch(err) {
    console.error('Error calculating sublunar point:', err);
    if (moonMarker) moonMarker.remove();
    if (footprintCircle) footprintCircle.remove();
    moonMarker = null;
    footprintCircle = null;
  }
}

// UI wiring
document.getElementById('hour').addEventListener('input', ()=>{
  const hh=Math.floor(parseInt(document.getElementById('hour').value)/2);
  const mm=(parseInt(document.getElementById('hour').value)%2)?30:0;
  document.getElementById('hour-value').textContent=`Time (UTC): ${String(hh).padStart(2,'0')}:${mm===0?'00':'30'}`;
  updateMap();
});

function adjustDate(days){
  const dateInput=document.getElementById('date');
  const cur=new Date(dateInput.value);
  cur.setDate(cur.getDate()+days);
  dateInput.valueAsDate=cur;
  updateMap();
}

document.getElementById('prevDay').addEventListener('click',()=>adjustDate(-1));
document.getElementById('nextDay').addEventListener('click',()=>adjustDate(1));
document.getElementById('date').addEventListener('change',updateMap);

// Init
window.onload = ()=>{
  const now=new Date();
  const utcDate=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()));
  document.getElementById('date').valueAsDate=utcDate;

  const utcHours=now.getUTCHours();
  const utcMinutes=now.getUTCMinutes();
  let roundedHour=utcHours;
  let roundedMinutes=(utcMinutes>=15 && utcMinutes<45)?30:0;
  if (utcMinutes>=45){ roundedHour+=1; roundedMinutes=0; }
  if (roundedHour>=24){ roundedHour-=24; utcDate.setUTCDate(utcDate.getUTCDate()+1); document.getElementById('date').valueAsDate=utcDate; }
  const hourIndex=roundedHour*2+(roundedMinutes===30?1:0);
  document.getElementById('hour').value=hourIndex;
  document.getElementById('hour-value').textContent=`Time (UTC): ${String(roundedHour).padStart(2,'0')}:${roundedMinutes===0?'00':'30'}`;

  initMap();
};
</script>
</body>
</html>
